<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="../styles/js/face-api.min.js"></script>
    <link href="../styles/styles.css" rel="stylesheet">
    <style>
        body {
            background-color: linear-gradient(to right, #ff7e5f, #feb47b);
            color: white;
            text-align: center;
        }

        .quiz-container {
            max-width: 550px;
            border: 5px solid gold;
            padding: 20px;
            border-radius: 10px;
            background: #222;
            margin-top: 20px;
        }

        .option {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background-color: white;
            border: 1px solid black;
            color: black;
            font-size: 18px;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .option:hover {
            background: linear-gradient(to right, #ff7e5f, #feb47b);
            color: black;
        }

        #timer {
            font-size: 24px;
            font-weight: bold;
        }

        #back {
            min-height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    <script>
        window.onload = function () {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                //   alert('You must log in to access this page.');
                window.location.href = 'login.html'; // Redirect to the login page
            }
        };
        document.addEventListener("DOMContentLoaded", function () {
            let score = 0;
            let questionIndex = 0;
            let questions = [];
            let timeLeft = 1200;
            let timer;
            let selectedAnswers = {};
            const canvas = document.createElement('canvas');

            const submitButton = document.getElementById("submitButton");
            function updateTimer() {
                const timerElement = document.getElementById("timer");
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `Time Left: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 300) {
                    timerElement.style.color = "red";
                }

                if (timeLeft === 0 || questionIndex >= 10) {
                    showResult();
                    clearInterval(timer);
                    return;
                }

                timeLeft--;
            }
            function loadQuestion() {
                if (questionIndex >= 10) {
                    showResult();
                    return;
                }
                const container = document.getElementById("container");
                container.innerHTML = "";
                const questionData = questions[questionIndex];
                const questionElement = document.createElement("h2");
                questionElement.textContent = questionData.question;
                container.appendChild(questionElement);
                questionData.options.forEach(option => {
                    const button = document.createElement("button");
                    button.textContent = option;
                    button.classList.add("option");
                    if (selectedAnswers[questionIndex] === option) {
                        button.style.backgroundColor = "gold";
                    }
                    button.addEventListener("click", function () {
                        selectedAnswers[questionIndex] = option;
                        document.querySelectorAll(".option").forEach(btn => btn.style.backgroundColor = "white");
                        button.style.backgroundColor = "gold";
                    });

                    container.appendChild(button);
                });

                updateButtons();
            }

            function updateButtons() {
                const prevButton = document.getElementById("prevButton");
                const nextButton = document.getElementById("nextButton");

                prevButton.disabled = questionIndex === 0;

                if (questionIndex === questions.length - 1) {
                    nextButton.style.display = "none";
                    submitButton.style.display = "inline-block";
                } else {
                    nextButton.style.display = "inline-block";
                    submitButton.style.display = "none";
                }
            }
            function showResult() {
                clearTimeout(timer);
                const container = document.getElementById("container");
                container.innerHTML = `
                <h2>Quiz Completed!</h2>
                <p>Your Score: ${score}/10</p>
                <button id="registerButton" class="option " style="margin-top: 15px;background-color:linear-gradient(to right, #ff7e5f, #feb47b)">Go to Registration</button>
            `;

                document.getElementById("prevButton").style.display = "none";
                submitButton.style.display = "none";

                document.getElementById("registerButton").addEventListener("click", function () {
                    window.location.href = "registration.html";
                });
            }

            document.getElementById("nextButton").addEventListener("click", function () {
                if (questionIndex < questions.length - 1) {
                    questionIndex++;
                    loadQuestion();
                }
            });

            document.getElementById("prevButton").addEventListener("click", function () {
                if (questionIndex > 0) {
                    questionIndex--;
                    loadQuestion();
                }
            });

            document.getElementById("submitButton").addEventListener("click", async function () {
                try {
                    // Capture the user's face from the video stream
                    loadingOverlay.style.display = 'flex'; // Show loading overlay
                    const email = sessionStorage.getItem('email').value

                    const options = new faceapi.TinyFaceDetectorOptions({
                        inputSize: 416, // Higher size for better accuracy
                        scoreThreshold: 0.5 // Confidence threshold
                    });
                    // Draw the video frame onto the canvas
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const canvasDetection = await faceapi.detectSingleFace(canvas, options)
                        .withFaceLandmarks()
                        .withFaceDescriptor();


                    if (!canvasDetection) {
                        alert('No face detected. Ensure your face is visible in the camera.');
                        loadingOverlay.style.display = 'flex'; // Show loading overlay

                        return;
                    }

                    // Get the stored image descriptor
                    const storedImagePath = '../../uploads/' + email + '.jpg'; // Update this path
                    const storedDescriptor = await getLocalImageDescriptor(storedImagePath);

                    // Compare the current descriptor with the stored descriptor
                    const isMatch = compareFaceDescriptors(canvasDetection.descriptor, storedDescriptor);

                    if (isMatch) {
                        // alert('Login successful! Faces match.');
                        // Redirect to a new page or perform other login actions
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('email', email);
                        window.location.href = 'instruction.html';
                    } else {
                        alert('Login failed. Faces do not match.');
                    }
                } catch (error) {
                    console.error('Error during login:', error);
                }
            });
            function compareFaceDescriptors(descriptor1, descriptor2) {
                const distance = faceapi.euclideanDistance(descriptor1, descriptor2);
                const threshold = 0.6; // Adjust as needed
                return distance < threshold;
            }
            async function getLocalImageDescriptor(imagePath) {
                const imageOld = await faceapi.fetchImage(imagePath);
                const detectionsOld = await faceapi.detectSingleFace(imageOld, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptor();

                if (!detectionsOld) {
                    throw new Error('No face detected in the stored image.');
                }

                return detectionsOld.descriptor; // Return the 128-dimensional face descriptor
            }
            function compareFaces(storedDescriptor, liveDescriptor) {
                const distance = faceapi.euclideanDistance(storedDescriptor, liveDescriptor);

                // Define a threshold (e.g., 0.6) for face similarity
                const threshold = 0.6;
                if (distance < threshold) {
                    console.log('Faces match! Distance:', distance);
                    return true;
                } else {
                    console.log('Faces do not match. Distance:', distance);
                    return false;
                }
            }

            fetch("que.json")
                .then(response => response.json())
                .then(data => {
                    questions = data.questions.sort(() => 0.5 - Math.random()).slice(0, 10);
                    loadQuestion();
                    timer = setInterval(updateTimer, 1000);
                })
                .catch(error => console.error("Error loading JSON:", error));
        });
    </script>


    <title>BLU Eye - Quiz</title>
</head>

<body>
    <div id="back" class="gradient-custom-2 h-100">
        <div>
            <h2 id="timer" class="mb-3">Time Left: 20:00</h2>
            <div class="quiz-container" style="background-color: white; color: black; border: 1px solid black;">
                <div id="container"></div>
            </div>
            <div style="margin-top: 20px;">
                <button id="prevButton" class="option">Previous</button>
                <button id="nextButton" class="option">Next</button>
                <button id="submitButton" class="option" style="display: none;">Submit</button>
                <div id="camera" class="float-right" style="background-color: white;">
                    <video id="video" autoplay></video>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('../models'),
        faceapi.nets.faceLandmark68Net.loadFromUri('../models'),
        faceapi.nets.faceRecognitionNet.loadFromUri('../models'),
        // faceapi.nets.tinyFaceDetector.loadFromUri('../models')
    ]).then(() => {
        console.log('FaceAPI models loaded.');
    });
    navigator.mediaDevices.getUserMedia({ video: true })
        .then((cameraStream) => {
            stream = cameraStream;
            video.srcObject = stream;
        })
        .catch((err) => {
            console.error("Error accessing the camera: ", err);
            alert("Unable to access the camera.");
        });
    var count = 0;
    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "hidden") {
            count++;
            alert("Please stay on this tab to continue!");
        }
    });
    async function enterFullscreen() {
        try {
            await document.documentElement.requestFullscreen();
        } catch (error) {
            console.error("Error entering fullscreen mode:", error);
        }
    }

    // Automatically enter fullscreen when the page loads
    window.onload = enterFullscreen;

    async function monitorUser() {
        const video = document.getElementById('video');

        // Set up options for the face detector
        const detectionOptions = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });

        setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, detectionOptions)
                .withFaceLandmarks();
            console.log(detections);
            if (detections.length === 0) {
                alert("No face detected. Please stay in front of the camera!");
            } else if (detections.length > 1) {
                alert("Multiple faces detected. Please ensure you're alone!");
            } else {
                const face = detections[0].landmarks;
                const nose = face.getNose();

                // Check if the user is looking away
                const faceCenterX = nose[0].x;
                const videoWidth = video.videoWidth;

                if (faceCenterX < videoWidth * 0.3 || faceCenterX > videoWidth * 0.7) {
                    alert("You seem to be looking away. Please focus on the screen.");
                }
            }
        }, 1000); // Check every second
    }

    function alertUser(message) {
        console.log(message); // Replace with on-screen notification or toast
    }
    window.onload = function () {
        const isLoggedIn = sessionStorage.getItem('isLoggedIn');
        if (!isLoggedIn) {
            //   alert('You must log in to access this page.');
            window.location.href = 'login.html'; // Redirect to the login page
        }
    };
    function saveResult(email, questionNumber, timeRemaining) {
        fetch("../backend/result.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, questionNumber, timeRemaining }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error saving result:", data.error);
                } else {
                    console.log(data.message);
                }
            })
            .catch(error => {
                console.error("Network error:", error);
            });
    }

    monitorUser();

</script>

</html>